apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: upgrade-inflight-pr-serial-2
spec:
  serviceAccountName: pipeline
  pipelineSpec:
    tasks:
      - name: wait-for-upgrade-release
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: openshift-client
            - name: namespace
              value: openshift-pipelines
        params:
          - name: SCRIPT
            value: |
              #!/usr/bin/env sh
              set -eu

              NS="$(context.pipelineRun.namespace)"
              CM="upgrade-inflight-signal"

              echo "[$(date -u)] [wait] Waiting for ConfigMap/${CM} in namespace ${NS} (data.release=true) ..."
              while :; do
                val="$(oc get cm "${CM}" -n "${NS}" -o jsonpath='{.data.release}' 2>/dev/null || true)"
                if [ "${val}" = "true" ]; then
                  echo "[$(date -u)] [wait] Release signal detected."
                  break
                fi
                echo "[$(date -u)] [wait] Not released yet (release=${val:-<empty>}). Sleeping..."
                sleep 10
              done
      - name: after-release
        runAfter:
          - wait-for-upgrade-release
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: openshift-client
            - name: namespace
              value: openshift-pipelines
        params:
          - name: SCRIPT
            value: |
              #!/usr/bin/env sh
              set -eu
              echo "[$(date -u)] [after-release] Upgrade in-flight pipeline continued after release."
              sleep 5
              echo "[$(date -u)] [after-release] Done."
  timeouts:
    pipeline: 2h


