apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: upgrade-inflight-pr-parallel-3
spec:
  serviceAccountName: pipeline
  pipelineSpec:
    tasks:
      - name: wait-a
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: openshift-client
            - name: namespace
              value: openshift-pipelines
        params:
          - name: SCRIPT
            value: |
              #!/usr/bin/env sh
              set -eu

              NS="$(context.pipelineRun.namespace)"
              CM="upgrade-inflight-signal"

              echo "[$(date -u)] [wait-a] Waiting for ConfigMap/${CM} in namespace ${NS} (data.release=true) ..."
              while :; do
                val="$(oc get cm "${CM}" -n "${NS}" -o jsonpath='{.data.release}' 2>/dev/null || true)"
                if [ "${val}" = "true" ]; then
                  echo "[$(date -u)] [wait-a] Release signal detected."
                  break
                fi
                echo "[$(date -u)] [wait-a] Not released yet (release=${val:-<empty>}). Sleeping..."
                sleep 10
              done
      - name: wait-b
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: openshift-client
            - name: namespace
              value: openshift-pipelines
        params:
          - name: SCRIPT
            value: |
              #!/usr/bin/env sh
              set -eu

              NS="$(context.pipelineRun.namespace)"
              CM="upgrade-inflight-signal"

              echo "[$(date -u)] [wait-b] Waiting for ConfigMap/${CM} in namespace ${NS} (data.release=true) ..."
              while :; do
                val="$(oc get cm "${CM}" -n "${NS}" -o jsonpath='{.data.release}' 2>/dev/null || true)"
                if [ "${val}" = "true" ]; then
                  echo "[$(date -u)] [wait-b] Release signal detected."
                  break
                fi
                echo "[$(date -u)] [wait-b] Not released yet (release=${val:-<empty>}). Sleeping..."
                sleep 10
              done
      - name: join
        runAfter:
          - wait-a
          - wait-b
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: openshift-client
            - name: namespace
              value: openshift-pipelines
        params:
          - name: SCRIPT
            value: |
              #!/usr/bin/env sh
              set -eu
              echo "[$(date -u)] [join] Both parallel waits finished. Completing PipelineRun."
              sleep 2
              echo "[$(date -u)] [join] Done."
  timeouts:
    pipeline: 2h


